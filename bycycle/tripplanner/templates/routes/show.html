<%inherit file="/layout.html"/>

<%
    route = result
    distance = route.distance
    total_mi = distance['miles']
    total_km = distance['kilometers']
    start = route.start
    end = route.end
    directions = route.directions
    linestring = route.linestring_lat_long
    centroid = linestring.centroid
    s_addr = h.literal(start.address.as_string('<br>'))
    e_addr = h.literal(end.address.as_string('<br>'))
    s_addr_one_line = start.address.as_string(', ')
    e_addr_one_line = end.address.as_string(', ')
    s_href = request.resource_url('find_geocode', query={'q': q, 'q_id': start.id})
    e_href = request.resource_url('find_geocode', query={'q': q, 'q_id': end.id})
    reverse_directions_href = request.resource_url('find_route', query={
        's': e_addr_one_line, 's_id': end.id,
        'e': s_addr_one_line, 'e_id': start.id,
    })
    reverse_directions_onclick = (
        "byCycle.UI.reverseDirections({{"
            "s: '{e_addr}', s_id: '{end.id}',"
            "e: '{s_addr}', e_id: '{start.id}'"
        "}});"
        "return false;"
        .format(e_addr=e_addr_one_line, s_addr=s_addr_one_line, start=start, end=end)
    )
    set_center_onclick = 'byCycle.UI.map.setCenterFromLatLong([{x}, {y}]); return false;'
    tab = h.literal('&nbsp;' * 4)
%>

<div>
    <div class="start">
        <a href="${s_href}"
           title="Start of route"
           onclick="${set_center_onclick.format(x=start.lat_long.x, y=start.lat_long.y)}; return false;"
           >${s_addr}</a>
    </div>

    <div class="end">
        <a href="${e_href}"
           title="End of route"
           onclick="${set_center_onclick.format(x=end.lat_long.x, y=end.lat_long.y)}; return false;"
           >${e_addr}</a>
    </div>

    <div class="total-distance">
        ${'%.2f' % total_mi} miles / ${'%.2f' % total_km} km
    </div>

    <div class="noprint reverse-directions">
        <a href="${reverse_directions_href}"
           onclick="${reverse_directions_onclick}">Reverse Directions</a>
    </div>

    <div class="directions">
        % for d in directions:
            <%
                turn = d['turn']
                street = d['street']
                point = linestring.coords[d['linestring_index']]
                if turn == 'straight':
                    turn = 'cont.'
                    street = street[1]
                if street == 'None':
                    street = '[No name]'
                street = ' - '.join([s.strip() for s in street.split('-') if s])
                if loop.first:
                    street = street  # XXX: '{0} toward {toward}'.format(street, **d)
                ls_index = d['linestring_index']
                distance = d['distance']
                mi = '%.2f' % distance['miles']
                km = '%.2f' % distance['kilometers']
                row_class = loop.cycle('a', 'b')
            %>
            <div class="direction ${row_class}">
                <span class="count">
                    <a href="#"
                       onclick="${set_center_onclick.format(x=point[0], y=point[1])}"
                       >${loop.index + 1}</a>
                </span>
                -
                <span class="turn">${turn.title()}</span>
                -
                <span class="direction">${street}</span>
                -
                <span class="segment_distance">${mi} mi</span>
                % if d['jogs']:
                    <div class="jogs">
                        ${tab} Jogs...
                        % for j in d['jogs']:
                            <br/>${tab}${tab}&middot; <i>${j['turn']}</i> at ${j['street']}
                        % endfor
                    </div>
                % endif
            </div>
        % endfor

        <div class="direction ${'a' if row_class == 'b' else 'b'}">
            <span class="count">
                <a href="#"
                   onclick="${set_center_onclick.format(x=end.lat_long.x, y=end.lat_long.y)}"
                   >${len(directions) + 1}</a>
            </span>
            -
            <span class="turn">End</span>
            -
            <span class="direction">${str(end.address).split('\n')[0]}</span>
        </div>
    </div>
</div>
